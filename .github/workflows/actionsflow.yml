# name: Actionsflow
# on:
#   # schedule:
#   #   - cron: "0 * * * *"
#   push:
#     branches:
#       - main
#   repository_dispatch:
#   workflow_dispatch:
#     inputs:
#       include:
#         description: "--include: workflow file filter, you can use glob format to filter your workflows, the default value is empty value, means no filter will be using"
#         required: false
#         default: ""
#       force:
#         description: "--force: whether force to run workflow, true or false"
#         required: false
#         default: "false"
#       verbose:
#         description: "--verbose: debug workflow, true or false"
#         required: false
#         default: "false"
# jobs:
#   run:
#     runs-on: ubuntu-latest
#     name: Run
#     concurrency: actionsflow
#     steps:
#       - uses: actions/checkout@v3
#       - name: Run Actionsflow
#         uses: actionsflow/actionsflow-action@v1.3.0
#         with:
#           args: "build --include ${{ github.event.inputs.include || ''}} -f ${{github.event.inputs.force=='true' && 'true' || 'false'}} --verbose ${{github.event.inputs.verbose=='true' && 'true' || 'false'}}"
#           json-secrets: ${{ toJSON(secrets) }}
#           json-github: ${{ toJSON(github) }}
#       - name: Setup act
#         uses: actionsflow/setup-act-for-actionsflow@v1.2.0
#       - name: Run act
#         run: act --workflows ./dist/workflows --secret-file ./dist/.secrets --eventpath ./dist/event.json --env-file ./dist/.env -P ubuntu-latest=ghcr.io/catthehacker/ubuntu:act-latest

name: Actionsflow
on:
  schedule:
    - cron: "0 * * * *"
  push:
    branches:
      - main
  repository_dispatch:
  workflow_dispatch:
    inputs:
      include:
        description: "--include: workflow file filter, you can use glob format to filter your workflows, the default value is empty value, means no filter will be using"
        required: false
        default: ""
      force:
        description: "--force: whether force to run workflow, true or false"
        required: false
        default: "false"
      verbose:
        description: "--verbose: debug workflow, true or false"
        required: false
        default: "false"

jobs:
  run:
    runs-on: ubuntu-latest
    name: Run
    concurrency: actionsflow
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v3

      - name: Install Actionsflow
        run: npm install -g actionsflow

      - name: Run Actionsflow
        run: |
          actionsflow build \
            --include "${{ github.event.inputs.include || '' }}" \
            -f "${{ github.event.inputs.force == 'true' && 'true' || 'false' }}" \
            --verbose "${{ github.event.inputs.verbose == 'true' && 'true' || 'false' }}"

      - name: Setup act
        uses: actionsflow/setup-act-for-actionsflow@v1.2.0

      - name: Run act
        run: act --workflows ./dist/workflows --secret-file ./dist/.secrets --eventpath ./dist/event.json --env-file ./dist/.env -P ubuntu-latest=ghcr.io/catthehacker/ubuntu:act-latest

      - name: Commit and Push README changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if there are any changes to commit
          if ! git diff --quiet HEAD -- README.md || ! git diff --cached --quiet HEAD -- README.md; then
            echo "Changes detected in README.md"
            
            # Stage any changes first
            git add README.md
            
            # Try to pull and handle conflicts gracefully
            echo "Fetching latest changes..."
            git fetch origin main
            
            # Check if we're behind the remote
            BEHIND=$(git rev-list HEAD..origin/main --count)
            if [ "$BEHIND" -gt 0 ]; then
              echo "Local branch is $BEHIND commits behind. Attempting to sync..."
              
              # Stash current changes if any
              git stash push -m "Temporary stash for sync"
              
              # Pull the latest changes
              git pull origin main --ff-only
              
              # Pop the stashed changes
              if git stash list | grep -q "Temporary stash for sync"; then
                git stash pop
              fi
              
              # Re-stage the changes after sync
              git add README.md
            fi
            
            # Commit the changes
            git commit -m "Update README with daily fact" || echo "No new changes to commit"
            
            # Push with force-with-lease for safety
            if ! git push origin main --force-with-lease; then
              echo "Push failed, trying alternative approach..."
              # If push fails, try once more with a fresh pull
              git pull origin main --rebase
              git push origin main
            fi
          else
            echo "No changes detected in README.md"
          fi
